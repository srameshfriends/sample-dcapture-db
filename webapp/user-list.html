<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Users</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/line-awesome.css">
    <link rel="stylesheet" href="css/line-awesome-font-awesome.css">

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/js.cookie.min.js"></script>

    <style>
        .pointer {
            cursor: pointer;
            padding: 2px 4px;
        }

    </style>

    <script>

        function showError(err) {
            alert(JSON.stringify(err.responseText));
        }

        function loadRecords() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: "user/search",
                error: showError,
                success: function (data) {
                    let dataTable = new DataTable();
                    dataTable.setData(data);
                }
            });
        }

        function updateUser(data) {
            let dataTxt = JSON.stringify(data);
            Cookies.set('userObject', dataTxt, {expires: 1, path: '/'});
            window.location.href = 'user-form.html';
        }

        function deleteUser(data) {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: "user/delete",
                data: JSON.stringify(data),
                error: showError,
                success: function () {
                    loadRecords();
                }
            });
        }


        function DataTable() {
            this.columns = ["email", "userName", "fullName"];
            this.clearAll();
        }

        DataTable.prototype.clearAll = function () {
            $("#tableBody").empty();
            this.dataMap = new Map();
        };

        DataTable.prototype.addEditCell = function (row, data) {
            let cell = $("<td><i class='la la-edit pointer'></i></td>");
            cell.click(function () {
                updateUser(data);
            });
            row.append(cell);
            return cell;
        };

        DataTable.prototype.addDeleteCell = function (row, data) {
            let cell = $("<td><i class='la la-trash-o pointer'></i></td>");
            cell.click(function () {
                deleteUser(data);
            });
            row.append(cell);
            return cell;
        };

        DataTable.prototype.addCell = function (row, txt) {
            let cell = $("<td></td>");
            if (typeof txt === "undefined" || txt === "null") {
                txt = "";
            }
            cell.text(txt);
            row.append(cell);
            return cell;
        };

        DataTable.prototype.addRow = function (data) {
            let name, idx, row = $("<tr></tr>"), body = $("#tableBody");
            const rowId = "RID" + body.children().length;
            this.addEditCell(row, data);
            for (idx = 0; idx < this.columns.length; idx++) {
                name = this.columns[idx];
                this.addCell(row, data[name]);
            }
            this.addDeleteCell(row, data);
            row.data("rowId", rowId);
            this.dataMap.set(rowId, data);
            body.append(row);
            return row;
        };


        DataTable.prototype.setData = function (dataArray) {
            let idx, data;
            this.clearAll();
            for (idx = 0; idx < dataArray.length; idx++) {
                data = dataArray[idx];
                this.addRow(data);
            }
        };
    </script>
</head>
<body>

<nav class="navbar navbar-expand-sm bg-light">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="user-register.html">Add User</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="user-list.html">Users</a>
        </li>
    </ul>
</nav>


<div class="container">
    <h4>User List</h4>
    <br>
    <table class="table">
        <thead>
        <tr id="tableHeader">
            <th data-name="editRow" width="40px">Edit</th>
            <th data-name="email">Email</th>
            <th data-name="userName">User Name</th>
            <th data-name="fullName">Full Name</th>
            <th data-name="deleteRow" width="40px">Delete</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<script>

    $(document).ready(function () {
        loadRecords();
    });

</script>

</body>
</html>